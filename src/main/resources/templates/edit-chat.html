<!-- src/main/resources/templates/edit-chat.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{layout/main :: layout(~{::title}, ~{::section})}">
<head>
    <title th:text="'Manage ' + ${chat.chatName} + ' - ChattyBuddies'">Manage Chat</title>
</head>
<body>
    <section class="edit-chat">
        <h2>Manage Chat: <span th:text="${chat.chatName}"></span></h2>
        
        <div class="card">
            <h3>Chat Details</h3>
            <form id="updateChatForm" class="standard-form">
                <div class="form-group">
                    <label for="chatName">Chat Name</label>
                    <input type="text" id="chatName" name="chatName" th:value="${chat.chatName}" required>
                </div>
                <div class="form-group">
                    <label>Chat Code</label>
                    <div class="code-display">
                        <span th:text="${chat.chatCode}"></span>
                        <span class="copy-hint">(Share this code to invite members)</span>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn primary">Update Name</button>
                </div>
            </form>
        </div>
        
        <div class="card">
            <h3>Invite Users</h3>
            <form id="inviteForm" class="standard-form">
                <div class="form-group">
                    <label for="inviteUsername">Username</label>
                    <input type="text" id="inviteUsername" name="username" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn primary">Send Invitation</button>
                </div>
            </form>
            <div id="inviteResult"></div>
        </div>
        
        <div class="card">
            <h3>Members</h3>
            <div class="member-list edit-members">
                <div th:each="member : ${chat.members}" class="member-item">
                    <div class="member-info">
                        <span class="member-name" th:text="${member.username}"></span>
                        <span class="member-badge" th:if="${member.id == chat.host.id}">Host</span>
                    </div>
                    <div class="member-actions" th:if="${member.id != chat.host.id}">
                        <button class="btn small danger remove-member" th:data-username="${member.username}">Remove</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card danger-zone">
            <h3>Danger Zone</h3>
            <button id="deleteChat" class="btn danger">Delete Chat</button>
        </div>
    </section>
    
    <script th:inline="javascript">
        const chatId = '[[${chat.id}]]';
        
        // Update chat name
        document.getElementById('updateChatForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newName = document.getElementById('chatName').value;
            
            fetch(`/api/chat/${chatId}/name?newName=${encodeURIComponent(newName)}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update chat name');
                }
                return response.json();
            })
            .then(data => {
                alert('Chat name updated successfully');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update chat name. Please try again.');
            });
        });
        
        // Invite user
        document.getElementById('inviteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('inviteUsername').value;
            const resultDiv = document.getElementById('inviteResult');
            
            fetch(`/api/chat/${chatId}/invite?username=${encodeURIComponent(username)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                return response.json().then(data => {
                    if (!response.ok) {
                        throw new Error(data.message || 'Failed to invite user');
                    }
                    return data;
                });
            })
            .then(data => {
                resultDiv.textContent = 'Invitation sent successfully';
                resultDiv.className = 'success-message';
                document.getElementById('inviteUsername').value = '';
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.textContent = error.message || 'Failed to invite user';
                resultDiv.className = 'error-message';
            });
        });
        
        // Remove member
        document.querySelectorAll('.remove-member').forEach(button => {
            button.addEventListener('click', function() {
                const username = this.getAttribute('data-username');
                if (confirm(`Are you sure you want to remove ${username} from this chat?`)) {
                    fetch(`/api/chat/${chatId}/members/${encodeURIComponent(username)}`, {
                        method: 'DELETE'
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to remove member');
                        }
                        return response.text();
                    })
                    .then(data => {
                        alert('Member removed successfully');
                        location.reload();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to remove member. Please try again.');
                    });
                }
            });
        });
        
        // Delete chat
        document.getElementById('deleteChat').addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this chat? This action cannot be undone.')) {
                fetch(`/api/chat/${chatId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to delete chat');
                    }
                    return response.text();
                })
                .then(data => {
                    alert('Chat deleted successfully');
                    window.location.href = '/chats';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to delete chat. Please try again.');
                });
            }
        });
    </script>
</body>
</html>